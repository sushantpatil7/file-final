name: SAL SQL Deployment Validation

on:
  pull_request:
    paths:
      - "sal/deployment/**/*.sql"

jobs:
  validate-sql:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get changed SQL files
        id: changed-files
        run: |
          git fetch origin ${{ github.base_ref }}
          files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '^sal/deployment/.*\.sql$' || true)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Validate SQL files
        run: |
          set -e
          for file in ${{ steps.changed-files.outputs.files }}; do
            echo "Validating $file"

            # Path validation
            if [[ ! "$file" =~ ^sal/deployment/SCT-[0-9]+/.+\.sql$ ]]; then
              echo "❌ Invalid path: $file"
              exit 1
            fi

            filename=$(basename "$file")

            # Filename date + version validation
            if [[ ! "$filename" =~ ^.+_[0-9]{4}_[0-9]{2}_[0-9]{2}_v[0-9]+\.sql$ ]]; then
              echo "❌ Invalid filename format: $filename"
              exit 1
            fi

            # Extract date
            date_part=$(echo "$filename" | grep -oE '[0-9]{4}_[0-9]{2}_[0-9]{2}')
            year=${date_part:0:4}
            month=${date_part:5:2}
            day=${date_part:8:2}

            # Validate date
            if ! date -d "$year-$month-$day" >/dev/null 2>&1; then
              echo "❌ Invalid date in filename: $filename"
              exit 1
            fi

            echo "✅ $file passed validation"
          done
