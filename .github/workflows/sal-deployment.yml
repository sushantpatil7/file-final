name: SAL SQL Deployment

on:
  pull_request:
    paths:
      - 'sal/deployment/**/*.sql'

jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Install jq (required for JSON payload)
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # 3Ô∏è‚É£ Get changed SQL files in this PR (PR-safe diff)
      - name: Get changed SQL files
        id: get_sql_files
        run: |
          echo "Base SHA: ${{ github.event.pull_request.base.sha }}"
          echo "Head SHA: ${{ github.event.pull_request.head.sha }}"

          files=$(git diff --name-only \
            ${{ github.event.pull_request.base.sha }} \
            ${{ github.event.pull_request.head.sha }} \
            | grep '^sal/deployment/.*\.sql$' || true)

          echo "Changed SQL files:"
          echo "$files"

          echo "sql_files<<EOF" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 4Ô∏è‚É£ Invoke Lambda for each SCT
      - name: Invoke SQL Deployment Lambda
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: eu-north-1
        run: |
          files="${{ steps.get_sql_files.outputs.sql_files }}"

          if [ -z "$files" ]; then
            echo "‚ùå No SQL files detected. Exiting."
            exit 0
          fi

          echo "‚úÖ SQL files detected:"
          echo "$files"

          scts=$(echo "$files" | awk -F'/' '{print $3}' | sort | uniq)

          for sct in $scts; do
            echo "üîπ Processing SCT: $sct"

            changed_files=$(echo "$files" | grep "$sct" | jq -R . | jq -s .)

            payload=$(jq -n \
              --arg did "$sct" \
              --arg pr "${{ github.event.pull_request.number }}" \
              --argjson cf "$changed_files" \
              '{deployment_id:$did, pr_number:$pr, changed_sql_files:$cf}')

            echo "üöÄ Invoking Lambda with payload:"
            echo "$payload"

            aws lambda invoke \
              --function-name sal-sql-deployment-lambda \
              --region eu-north-1 \
              --payload "$payload" \
              response_$sct.json

            echo "üì• Lambda response:"
            cat response_$sct.json
          done
