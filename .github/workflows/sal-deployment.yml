name: SAL SQL Deployment

on:
  pull_request:
    paths:
      - 'sal/deployment/**/*.sql'

jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # üî• REQUIRED for PR diff

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq awscli

      - name: Get changed SQL files (PR-safe)
        id: get_sql_files
        run: |
          files=$(git diff --name-only origin/${{ github.base_ref }}...${{ github.head_ref }} | grep '^sal/deployment/.*\.sql' || true)
          echo "Changed SQL files:"
          echo "$files"
          echo "sql_files<<EOF" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Fail if no SQL files found
        if: steps.get_sql_files.outputs.sql_files == ''
        run: |
          echo "‚ùå No SQL files detected in PR"
          exit 1

      - name: Invoke Lambda per SCT
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          files="${{ steps.get_sql_files.outputs.sql_files }}"

          for sct in $(echo "$files" | awk -F'/' '{print $3}' | sort | uniq); do
            sct_files=$(echo "$files" | grep "$sct" | jq -R . | jq -s .)

            payload=$(jq -n \
              --arg deployment_id "$sct" \
              --arg pr_number "${{ github.event.pull_request.number }}" \
              --argjson changed_sql_files "$sct_files" \
              '{deployment_id:$deployment_id, pr_number:$pr_number, changed_sql_files:$changed_sql_files}')

            echo "üöÄ Invoking Lambda for $sct"
            echo "$payload"

            aws lambda invoke \
              --function-name sal-sql-deployment-lambda \
              --payload "$payload" \
              response_$sct.json

            cat response_$sct.json
          done
