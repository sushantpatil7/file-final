name: SAL SQL Deployment

on:
  pull_request:
    paths:
      - 'sal/deployment/**/*.sql'

jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Install jq
      - name: Install jq
        run: sudo apt-get install -y jq

      # 3️⃣ Get changed SQL files via GitHub API (CORRECT WAY)
      - name: Get changed SQL files
        id: sql_files
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          files=$(curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files \
            | jq -r '.[] | select(.filename | test("^sal/deployment/.*\\.sql$")) | .filename')

          echo "Changed SQL files:"
          echo "$files"

          echo "sql_files<<EOF" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 4️⃣ Extract SCT folders
      - name: Extract SCTs
        id: scts
        run: |
          scts=$(echo "${{ steps.sql_files.outputs.sql_files }}" | awk -F'/' '{print $3}' | sort | uniq)

          echo "Detected SCTs:"
          echo "$scts"

          echo "scts<<EOF" >> $GITHUB_OUTPUT
          echo "$scts" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 5️⃣ Invoke Lambda
      - name: Invoke Lambda
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: eu-north-1
        run: |
          files="${{ steps.sql_files.outputs.sql_files }}"
          scts="${{ steps.scts.outputs.scts }}"

          for sct in $scts; do
            sct_files=$(echo "$files" | grep "$sct")

            payload=$(jq -n \
              --arg did "$sct" \
              --arg pr "${{ github.event.pull_request.number }}" \
              --argjson cf "$(echo "$sct_files" | jq -R . | jq -s .)" \
              '{
                deployment_id: $did,
                pr_number: $pr,
                changed_sql_files: $cf
              }')

            echo "Invoking Lambda for $sct"
            echo "$payload"

            aws lambda invoke \
              --function-name sal-sql-deployment-lambda \
              --region eu-north-1 \
              --payload "$payload" \
              response_$sct.json

            cat response_$sct.json
          done
